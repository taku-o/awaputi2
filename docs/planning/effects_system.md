# BubblePop エフェクトシステム詳細

## エフェクトシステム構成

### アーキテクチャ概要
- **EffectManager**: 全画面効果の管理
- **ParticleManager**: パーティクル効果の制御
- **AnimationManager**: アニメーション効果の管理
- **EnhancedEffectManager**: 高度なエフェクト統合
- **EffectQualityController**: 品質制御システム
- **EffectPerformanceOptimizer**: パフォーマンス最適化

### 主要コンポーネント

#### EffectManager (エフェクト管理)
- 画面揺れ、フラッシュ、ズーム効果の制御
- 色調変更、ブラー効果
- コントラスト、明度、彩度調整
- 設定システムとの連携

#### ParticleManager (パーティクル管理)
- パーティクル生成・更新・描画
- 物理シミュレーション
- オブジェクトプール活用
- メモリ効率的な管理

#### AnimationManager (アニメーション管理)
- UI要素のアニメーション
- イージング関数の適用
- タイムライン制御
- 連続アニメーション管理

## エフェクトの種類

### 1. 全画面エフェクト (Screen Effects)

#### 画面揺れ (Screen Shake)
**基本画面揺れ**
- **種類**: `random`, `horizontal`, `vertical`, `circular`
- **強度**: 0.1 - 10.0 (設定で調整可能)
- **持続時間**: 100ms - 2000ms
- **用途**: 泡破裂、ダメージ時

**ダメージ揺れ**
- **パターン**: 短時間の激しい揺れ
- **強度**: 3.0 - 5.0
- **持続時間**: 200ms - 500ms
- **トリガー**: HP減少時

**爆発揺れ**
- **パターン**: 大きく長時間の揺れ
- **強度**: 5.0 - 8.0
- **持続時間**: 800ms - 1500ms
- **トリガー**: 爆発泡効果時

#### フラッシュ効果 (Flash Effects)
**ダメージフラッシュ**
- **色**: 赤色 (255, 0, 0)
- **透明度**: 0.3 - 0.7
- **持続時間**: 150ms - 300ms
- **用途**: HPダメージ時

**回復フラッシュ**
- **色**: 緑色 (0, 255, 0)
- **透明度**: 0.2 - 0.5
- **持続時間**: 200ms - 400ms
- **用途**: HP回復時

**実績フラッシュ**
- **色**: 金色 (255, 215, 0)
- **透明度**: 0.4 - 0.6
- **持続時間**: 500ms - 1000ms
- **用途**: 実績解除時

**ボーナスフラッシュ**
- **色**: 虹色 (グラデーション)
- **透明度**: 0.3 - 0.5
- **持続時間**: 300ms - 600ms
- **用途**: ボーナスタイム発動時

#### ズーム効果 (Zoom Effects)
**コンボズーム**
- **倍率**: 1.0 - 1.2
- **持続時間**: 100ms - 300ms
- **イージング**: easeOutQuart
- **用途**: 高コンボ達成時

**ボス泡ズーム**
- **倍率**: 0.9 - 1.1 (パルス)
- **持続時間**: 2000ms - 5000ms
- **イージング**: easeInOutSine
- **用途**: ボス泡出現時

#### 色調効果 (Tint Effects)
**時間停止色調**
- **色**: 青色 (0, 100, 255)
- **透明度**: 0.2 - 0.4
- **持続時間**: 時間停止効果中
- **用途**: 時計泡効果時

**毒色調**
- **色**: 緑色 (100, 255, 0)
- **透明度**: 0.1 - 0.3
- **持続時間**: 毒効果中
- **用途**: 毒泡の影響時

### 2. パーティクルエフェクト (Particle Effects)

#### 泡破裂パーティクル
**通常泡破裂**
- **パーティクル数**: 5-8個
- **色**: 青色系
- **サイズ**: 2-5px
- **速度**: 50-150px/s
- **寿命**: 0.3-0.8秒
- **物理**: 重力あり、空気抵抗あり

**石泡破裂**
- **パーティクル数**: 8-12個
- **色**: 灰色系
- **サイズ**: 3-7px
- **速度**: 80-200px/s
- **寿命**: 0.5-1.0秒
- **物理**: 重力強め、バウンスあり

**ダイヤモンド泡破裂**
- **パーティクル数**: 12-20個
- **色**: 虹色、キラキラ
- **サイズ**: 1-4px
- **速度**: 100-300px/s
- **寿命**: 0.8-1.5秒
- **物理**: 軽い、長時間浮遊

**ボス泡破裂**
- **パーティクル数**: 30-50個
- **色**: 多色、大きなパーティクル
- **サイズ**: 5-15px
- **速度**: 150-400px/s
- **寿命**: 1.0-2.0秒
- **物理**: 爆発的な拡散

#### 特殊効果パーティクル
**回復エフェクト**
- **パーティクル数**: 10-15個
- **色**: ピンク・白色
- **形状**: ハート型、十字型
- **動き**: 上昇しながら消失
- **寿命**: 1.0-1.5秒

**毒エフェクト**
- **パーティクル数**: 8-12個
- **色**: 緑色、暗い色調
- **形状**: 泡状、不規則
- **動き**: ゆらゆらと漂う
- **寿命**: 0.8-1.2秒

**電気エフェクト**
- **パーティクル数**: 15-25個
- **色**: 青白色、黄色
- **形状**: 稲妻状、線状
- **動き**: 激しく点滅
- **寿命**: 0.2-0.5秒

**爆発エフェクト**
- **パーティクル数**: 25-40個
- **色**: 赤・オレンジ・黄色
- **形状**: 火花状、破片状
- **動き**: 放射状に拡散
- **寿命**: 0.5-1.0秒

#### 環境パーティクル
**背景泡**
- **パーティクル数**: 5-10個 (常時)
- **色**: 半透明の青・白
- **サイズ**: 10-30px
- **動き**: ゆっくり上昇
- **寿命**: 5-10秒
- **用途**: 背景の雰囲気作り

**キラキラエフェクト**
- **パーティクル数**: 3-8個 (常時)
- **色**: 白・金色
- **サイズ**: 1-3px
- **動き**: ランダムに点滅
- **寿命**: 2-4秒
- **用途**: 魔法的な雰囲気

### 3. UIアニメーション (UI Animations)

#### メニューアニメーション
**フェードイン**
- **持続時間**: 300ms - 500ms
- **イージング**: easeOutCubic
- **用途**: 画面遷移時

**スライドイン**
- **方向**: 左から右、上から下
- **持続時間**: 400ms - 600ms
- **イージング**: easeOutBack
- **用途**: メニュー項目表示

**スケールアニメーション**
- **倍率**: 0.8 → 1.0
- **持続時間**: 200ms - 400ms
- **イージング**: easeOutElastic
- **用途**: ボタンクリック時

#### ゲーム内UIアニメーション
**スコア表示**
- **アニメーション**: 数値カウントアップ
- **持続時間**: 500ms - 1000ms
- **イージング**: easeOutQuart
- **用途**: スコア更新時

**HP表示**
- **アニメーション**: バー長さ変更
- **持続時間**: 300ms - 500ms
- **イージング**: easeInOutCubic
- **用途**: HP変化時

**コンボ表示**
- **アニメーション**: パルス + スケール
- **持続時間**: 200ms - 400ms
- **イージング**: easeOutBounce
- **用途**: コンボ発生時

#### 通知アニメーション
**実績通知**
- **アニメーション**: 右からスライドイン → 一時停止 → フェードアウト
- **持続時間**: 3000ms - 5000ms
- **イージング**: easeOutCubic
- **用途**: 実績解除時

**レベルアップ通知**
- **アニメーション**: 中央からスケールイン → パルス → フェードアウト
- **持続時間**: 2000ms - 3000ms
- **イージング**: easeOutElastic
- **用途**: レベルアップ時

### 4. 季節・テーマエフェクト (Seasonal Effects)

#### 季節エフェクト
**春エフェクト**
- **パーティクル**: 桜の花びら
- **色**: ピンク・白
- **動き**: ゆっくり舞い散る
- **期間**: 3月-5月

**夏エフェクト**
- **パーティクル**: 光の粒子
- **色**: 黄色・オレンジ
- **動き**: キラキラと輝く
- **期間**: 6月-8月

**秋エフェクト**
- **パーティクル**: 落ち葉
- **色**: 赤・オレンジ・黄色
- **動き**: ひらひらと落下
- **期間**: 9月-11月

**冬エフェクト**
- **パーティクル**: 雪の結晶
- **色**: 白・青白
- **動き**: ゆっくり降雪
- **期間**: 12月-2月

#### 特別イベントエフェクト
**新年エフェクト**
- **パーティクル**: 花火、紙吹雪
- **色**: 多色、華やか
- **動き**: 爆発的、祝祭的
- **期間**: 1月1日-3日

**誕生日エフェクト**
- **パーティクル**: 風船、紙吹雪
- **色**: カラフル
- **動き**: 浮遊、舞い散る
- **期間**: ユーザー設定日

## エフェクト品質システム

### 品質レベル
**low (低品質)**
- **パーティクル数**: 50%削減
- **エフェクト**: 基本のみ
- **アニメーション**: 簡素化
- **フレームレート**: 30fps対応

**medium (中品質)**
- **パーティクル数**: 75%
- **エフェクト**: 標準
- **アニメーション**: 標準
- **フレームレート**: 60fps対応

**high (高品質)**
- **パーティクル数**: 100%
- **エフェクト**: 全て有効
- **アニメーション**: 高品質
- **フレームレート**: 60fps維持

**ultra (最高品質)**
- **パーティクル数**: 150%
- **エフェクト**: 最高品質
- **アニメーション**: 最高品質
- **フレームレート**: 120fps対応

### 動的品質調整
- **フレームレート監視**: リアルタイムでFPS監視
- **自動品質低下**: FPS低下時の自動調整
- **メモリ使用量制御**: パーティクル数の動的制限
- **CPU負荷監視**: 処理負荷に応じた最適化

## パフォーマンス最適化

### メモリ最適化
**オブジェクトプール**
- **パーティクルプール**: 500個のパーティクルを再利用
- **エフェクトプール**: 100個のエフェクトオブジェクトを再利用
- **アニメーションプール**: 50個のアニメーションを再利用

**メモリ管理**
- **ガベージコレクション**: 定期的な不要オブジェクト削除
- **メモリリーク防止**: 適切な参照解除
- **メモリ使用量監視**: リアルタイム監視

### 描画最適化
**バッチレンダリング**
- **同種パーティクル**: まとめて描画
- **テクスチャアトラス**: 複数画像を1つにまとめる
- **描画コール削減**: 描画回数の最小化

**カリング処理**
- **視界外カリング**: 画面外のパーティクルを描画しない
- **距離カリング**: 遠すぎるパーティクルを描画しない
- **サイズカリング**: 小さすぎるパーティクルを描画しない

### CPU最適化
**処理分散**
- **フレーム分散**: 重い処理を複数フレームに分散
- **優先度制御**: 重要なエフェクトを優先処理
- **遅延処理**: 必要時まで処理を遅延

**計算最適化**
- **事前計算**: 可能な計算を事前に実行
- **近似計算**: 精度を落として高速化
- **キャッシュ活用**: 計算結果のキャッシュ



## 設定システム連携

### エフェクト設定
**基本設定**
- **エフェクト有効/無効**: 全エフェクトのオン/オフ
- **品質レベル**: 4段階の品質選択
- **パーティクル倍率**: 0.1 - 2.0倍の調整

**詳細設定**
- **画面揺れ強度**: 0.0 - 2.0倍の調整
- **フラッシュ強度**: 0.0 - 2.0倍の調整
- **パーティクル寿命**: 0.5 - 2.0倍の調整



## デバッグ・監視機能

### パフォーマンス監視
- **FPS表示**: リアルタイムフレームレート
- **パーティクル数表示**: アクティブなパーティクル数
- **メモリ使用量**: エフェクト関連のメモリ使用量
- **描画コール数**: 1フレームあたりの描画回数

### デバッグ表示
- **エフェクト境界**: エフェクトの当たり判定表示
- **パーティクル軌跡**: パーティクルの移動軌跡
- **パフォーマンスグラフ**: FPS・メモリ使用量のグラフ

### 統計情報
- **エフェクト使用統計**: 各エフェクトの使用頻度
- **パフォーマンス統計**: 平均FPS、最低FPS
- **エラー統計**: エフェクト関連のエラー発生率

## 技術実装詳細

### Canvas描画最適化
- **OffscreenCanvas**: バックグラウンドでの描画処理
- **ImageData操作**: ピクセル単位での高速描画
- **WebGL活用**: GPU加速による高速描画

### 物理シミュレーション
- **Verlet積分**: 安定した物理計算
- **空間分割**: 効率的な衝突判定
- **制約ソルバー**: 物理制約の解決

### メモリ管理
- **WeakMap活用**: メモリリークの防止
- **循環参照回避**: 適切な参照管理
- **定期クリーンアップ**: 不要オブジェクトの削除