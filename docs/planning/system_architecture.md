# BubblePop システム構成

## 全体アーキテクチャ

### アプリケーション構成
- **アプリケーションタイプ**: Single Page Application (SPA)
- **フロントエンド**: React + TypeScript
- **ゲームエンジン**: Phaser（ゲームプレイ画面のみ）
- **UI描画**: HTML + React（ゲームプレイ画面以外）
- **UIコンポーネント**: MUI (Material-UI)（HTML部分の画面で使用）
- **コンポーネント管理**: StoryBook（利用するコンポーネントの管理）
- **モノリポジトリ管理**: Lerna（モノリポジトリの管理ツール）
- **ビルドツール**: Vite
- **状態管理**: Zustand（軽量で高性能な状態管理）
- **多言語対応**: react-i18next + i18next（翻訳システム）
- **テスト**: Jest (単体) + Playwright (E2E)

### ディレクトリ構造
- 設計で決定

## コアシステム

### Phaser (ゲームエンジン)
- **役割**: 高性能な2Dゲーム描画・物理演算（ゲームプレイ画面のみ）
- **使用場面**: ゲームプレイ画面での泡の描画、物理演算、アニメーション
- **主要機能**:
  - スプライト管理
  - 物理エンジン (Arcade Physics, Matter.js)
  - アニメーションシステム
  - 音響管理
  - 入力処理
  - パーティクルシステム
  - カメラ制御

### GameEngine (ゲーム統合)
- **役割**: PhaserとReactの統合・制御
- **主要機能**:
  - Phaserゲームインスタンス管理
  - React状態との同期
  - システム間連携
  - パフォーマンス監視

### React Router (画面遷移)
- **役割**: SPA内での画面遷移制御
- **管理画面**:
  - MainMenu (メインメニュー)
  - Game (ゲームプレイ)
  - Settings (設定)
  - Help (ヘルプ)
  - StageSelect (ステージ選択)

### Zustand (状態管理)
- **GameStore**: ゲーム状態の一元管理
- **SettingsStore**: 設定値の一元管理
- **PlayerStore**: プレイヤーデータの管理
- **機能**:
  - 軽量で高性能な状態管理
  - 状態の保存・読み込み
  - 状態変更の監視
  - TypeScriptによる型安全性
  - React Hooksとの連携
  - デバッグツール対応

## ゲームシステム

### BubbleManager (泡管理)
- **役割**: Phaserスプライトとしての泡の生成・更新・削除
- **機能**:
  - Phaserスプライト生成
  - 物理演算による衝突判定
  - 泡の状態管理
  - 特殊効果処理
  - アニメーション制御

### ScoreManager (スコア管理)
- **役割**: スコア計算とコンボ管理
- **機能**:
  - 基本スコア計算
  - コンボ倍率適用
  - 年齢ボーナス
  - 特殊泡ボーナス

### AchievementManager (実績管理)
- **役割**: 実績の進捗追跡と解除
- **機能**:
  - 実績条件チェック
  - 進捗計算
  - 通知システム
  - 報酬付与

## 音響・視覚システム

### AudioManager (音響管理)
- **役割**: Phaser音響システムの統合制御（全画面で利用）
- **使用場面**: ゲームプレイ画面、メニュー画面、設定画面など全画面で音響再生
- **サブシステム**:
  - BGMSystem (背景音楽)
  - SoundEffectSystem (効果音)
  - PhaserAudioManager (Phaser音響管理)
  - SoundFileManager (音響ファイル管理)
- **主要機能**:
  - 音響ファイルの読み込み・管理
  - 音量・ミュート制御
  - 音響の再生・停止制御
  - 音響のループ・フェード制御

### EffectManager (エフェクト管理)
- **役割**: 視覚効果の制御
- **機能**:
  - 画面揺れ
  - フラッシュ効果
  - ズーム効果
  - 色調変更

### ParticleManager (パーティクル管理)
- **役割**: Phaserパーティクルシステムの制御
- **機能**:
  - Phaserパーティクル生成
  - 物理シミュレーション
  - レンダリング最適化
  - メモリ管理
  - パーティクルエミッター制御

## データ管理

### PlayerData (プレイヤーデータ)
- **保存データ**:
  - ユーザー名
  - レベル・経験値
  - 累計スコア
  - 解放ステージ
  - 実績進捗
  - 設定値

### LocalStorage構造
```typescript
interface PlayerData {
  username: string;
  level: number;
  experience: number;
  totalScore: number;
  unlockedStages: string[];
  achievements: Achievement[];
  settings: GameSettings;
}

// LocalStorage保存形式
{
  "bubblePopPlayerData": PlayerData
}
```

## パフォーマンス最適化

### メモリ管理
- オブジェクトプール
- ガベージコレクション最適化
- メモリリーク検出

### レンダリング最適化
- フレームレート制御
- カリング処理
- バッチレンダリング

### 品質制御
- 動的品質調整
- デバイス性能検出
- 負荷分散

## セキュリティ・エラー処理

### ErrorHandler (エラー処理)
- **機能**:
  - エラーキャッチ・ログ
  - ユーザーフレンドリーなエラー表示
  - 復旧処理
  - デバッグ情報収集

### セキュリティ対策
- XSS対策
- データバリデーション
- セキュアな設定管理

## 拡張性・保守性

### モジュラー設計
- React コンポーネント設計
- TypeScript による型安全性
- Zustandによる状態管理の分離
- カスタムフックによる再利用性
- 依存関係の明確化
- インターフェース統一

### 描画技術の使い分け
- **ゲームプレイ画面**: Phaser（ゲーム描画、物理演算、アニメーション）
- **その他の画面**: HTML + React + Framer Motion（メニュー、設定、ヘルプ、ショップなど）
- **音響システム**: Phaser音響（ゲーム内音響）+ Howler.js（UI音響）
  - **Phaser**: ゲーム内の効果音（ジャンプ音、衝突音）、シーン切り替えBGMなど、ゲームロジックと密接に関わる音声
  - **Howler.js**: 画面外音声、ウェブサイト全体共有BGM、UI効果音など、ゲームエンジンから独立した音声

### 技術選択の理由
- **Phaser**: ゲームプレイ画面での高性能な2D描画と物理演算
- **HTML + React + Framer Motion**: メニュー画面での柔軟なUI構築とアニメーション
- **Zustand**: 軽量で高性能な状態管理
- **Phaser音響**: ゲーム内音響の高品質再生
- **Howler.js**: UI音響の効率的な管理（画面外音声、ウェブサイト全体共有BGM、UI効果音）

### 設定駆動
- 外部設定ファイル
- 動的設定変更
- A/Bテスト対応
- 環境別設定

### ショートカットキー制限
- **制限事項**: 定義されたショートカットキー以外の追加は禁止
- **理由**: 操作の邪魔になる可能性があるため
- **対象キー**: ESC、S、H等の一般的なショートカットキーは使用しない
- **優先順位**: ゲームプレイ中の操作性を最優先とする

### Phaser採用の利点
- **高性能**: WebGL/Canvas2Dの自動選択
- **豊富な機能**: 物理演算、アニメーション、音響など
- **成熟したエコシステム**: 大量のプラグインとサンプル
- **TypeScript対応**: 完全な型定義サポート
- **React統合**: react-phaser等のライブラリで簡単統合