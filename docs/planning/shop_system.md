# BubblePop ショップシステム詳細

## ショップ画面概要

### アプリケーション構成
- **アプリケーションタイプ**: Single Page Application (SPA)
- **画面遷移**: ページリロードなしの高速な画面切り替え
- **状態保持**: ショップ画面での選択状態を保持

### 画面構成
- **タイトル**: 「アイテムショップ」
- **プレイヤー情報**: ユーザー名、所持AP、総TAP表示
- **アイテムリスト**: 購入可能アイテムの一覧表示
- **操作説明**: キーボード・マウス操作の説明
- **戻る**:

### 画面レイアウト
- 設計で決定

### 表示仕様
- **最大表示アイテム数**: 6個（スクロール対応）
- **アイテムカードサイズ**: 幅 canvas.width-40px、高さ 80px
- **選択状態**: 青色背景（購入可能）、オレンジ色背景（購入不可）
- **購入不可状態**: グレーアウト表示

## 操作方法

### キーボード操作
- **↑↓キー**: アイテム選択の移動

### マウス操作
- **クリック**: アイテムを選択して即座に購入
- **ホバー**: アイテムの詳細情報表示（実装予定）

### スクロール機能
- 6個以上のアイテムがある場合、自動スクロール
- 選択位置に応じて表示範囲を調整

## 購入可能アイテム

### 1. スコア倍率アップ (scoreMultiplier)
**基本情報:**
- **名前**: スコア倍率アップ
- **説明**: 獲得スコアが1.3倍になります（レベルごとに+0.2倍）
- **基本コスト**: 75 AP
- **最大レベル**: 5

**レベル別効果:**
```javascript
Level 1: 1.3倍 (コスト: 75 AP)
Level 2: 1.5倍 (コスト: 98 AP)
Level 3: 1.7倍 (コスト: 127 AP)
Level 4: 1.9倍 (コスト: 165 AP)
Level 5: 2.1倍 (コスト: 215 AP)
```

**効果の仕組み:**
- 全てのスコア獲得時に倍率が適用
- レベルアップごとに0.2倍ずつ増加
- 累積効果（他の倍率効果と乗算）

### 2. 復活 (revival)
**基本情報:**
- **名前**: 復活
- **説明**: HP全損時に一度だけ満タンで復活します
- **基本コスト**: 150 AP
- **最大レベル**: 2

**レベル別効果:**
```javascript
Level 1: 1回復活可能 (コスト: 150 AP)
Level 2: 2回復活可能 (コスト: 195 AP)
```

**効果の仕組み:**
- HPが0になった瞬間に自動発動
- HPを最大値まで回復
- 使用回数制限あり（レベル分まで）

### 3. レア率アップ (rareRate)
**基本情報:**
- **名前**: レア率アップ
- **説明**: レア泡の出現率が上昇します（レベルごとに+30%）
- **基本コスト**: 100 AP
- **最大レベル**: 4

**レベル別効果:**
```javascript
Level 1: 1.3倍 (コスト: 100 AP)
Level 2: 1.6倍 (コスト: 130 AP)
Level 3: 1.9倍 (コスト: 169 AP)
Level 4: 2.2倍 (コスト: 220 AP)
```

**効果の仕組み:**
- 特殊泡（虹色、黄金、ダイヤモンドなど）の出現率向上
- 泡生成時の確率計算に適用
- レベルアップごとに30%ずつ増加

### 4. HP増加 (hpBoost)
**基本情報:**
- **名前**: HP増加
- **説明**: 最大HPが25増加します
- **基本コスト**: 60 AP
- **最大レベル**: 6

**レベル別効果:**
```javascript
Level 1: +25 HP (コスト: 60 AP)
Level 2: +50 HP (コスト: 78 AP)
Level 3: +75 HP (コスト: 101 AP)
Level 4: +100 HP (コスト: 131 AP)
Level 5: +125 HP (コスト: 170 AP)
Level 6: +150 HP (コスト: 221 AP)
```

**効果の仕組み:**
- 最大HPの上限を増加
- ゲーム開始時のHPも増加
- 累積効果（基本100HP + レベル×25HP）

### 5. コンボ強化 (comboBoost)
**基本情報:**
- **名前**: コンボ強化
- **説明**: コンボ継続時間が1.5倍になります
- **基本コスト**: 80 AP
- **最大レベル**: 3

**レベル別効果:**
```javascript
Level 1: 1.5倍 (コスト: 80 AP)
Level 2: 2.0倍 (コスト: 104 AP)
Level 3: 2.5倍 (コスト: 135 AP)
```

**効果の仕組み:**
- コンボのタイムアウト時間を延長
- 基本2秒 → レベル1で3秒、レベル2で4秒、レベル3で5秒
- 高コンボの維持が容易になる

### 6. アイテム効果リセット (reset)
**基本情報:**
- **名前**: アイテム効果リセット
- **説明**: 全アイテム効果をリセットし、再購入可能にします
- **コスト**: 30 AP（固定）
- **最大レベル**: 1（使い切り）

**効果の仕組み:**
- 全ての購入済みアイテムをリセット
- 使用したAPは返還されない
- アイテムの再配分が可能
- リセット後は再度購入が必要

## コスト計算システム

### 基本コスト計算式
```javascript
cost = baseCost × (1.3 ^ currentLevel)
```

### レベル別コスト例（スコア倍率アップの場合）
```javascript
Level 0→1: 75 × (1.3^0) = 75 AP
Level 1→2: 75 × (1.3^1) = 98 AP
Level 2→3: 75 × (1.3^2) = 127 AP
Level 3→4: 75 × (1.3^3) = 165 AP
Level 4→5: 75 × (1.3^4) = 215 AP
```

### コスト設計の考え方
- **初期コスト**: 手軽に購入できる価格設定
- **レベルアップコスト**: 指数関数的に増加（1.3倍）
- **最大レベル制限**: 無限強化を防ぐバランス調整

## アイテム効果の適用

### 効果適用タイミング
1. **購入時**: 即座に効果が適用
2. **ゲーム開始時**: 全効果を再計算して適用
3. **ロード時**: セーブデータから効果を復元

### 効果の累積ルール
```javascript
// スコア倍率の累積例
baseMultiplier = 1.0
scoreMultiplierItem = 1.3 (Level 1)
otherMultiplier = 1.2 (他の効果)
finalMultiplier = baseMultiplier × scoreMultiplierItem × otherMultiplier = 1.56
```

### 効果の永続性
- **永続効果**: 一度購入すると常に適用
- **消費効果**: 復活アイテムは使用すると回数が減る
- **リセット**: リセットアイテムで全効果をクリア可能

## ショップUI詳細

### アイテムカード表示
```javascript
const itemCardDisplay = {
  // 基本情報
  name: "アイテム名 (Lv.X)",
  description: "効果説明",
  cost: "XXX AP",
  
  // 状態表示
  maxLevel: "[MAX]", // 最大レベル時
  purchased: "購入済み", // 最大レベル時
  
  // 現在効果
  currentEffect: "現在の倍率: x2.1", // 効果値表示
  
  // 色分け
  canPurchase: "青色背景",
  cannotPurchase: "グレー背景",
  selected: "白枠線"
};
```

### 購入確認システム
- **即座購入**: クリック・Enterで即座に購入
- **確認なし**: シンプルな操作性を重視
- **購入後更新**: アイテムリストとプレイヤー情報を即座に更新

### エラーハンドリング
```javascript
const purchaseErrors = {
  insufficientAP: "AP不足",
  maxLevel: "最大レベル到達済み",
  unknownItem: "不明なアイテム",
  systemError: "システムエラー"
};
```

## データ管理

### セーブデータ構造
```javascript
const playerData = {
  ap: 150,                    // 現在のAP
  ownedItems: [
    { id: "scoreMultiplier", level: 2 },
    { id: "hpBoost", level: 1 },
    { id: "revival", level: 1 }
  ]
};
```

### アイテム効果の保存
```javascript
const activeEffects = {
  scoreMultiplier: 1.5,       // 現在のスコア倍率
  hpBoost: 25,               // HP増加量
  revival: 1,                // 残り復活回数
  rareRate: 1.0,             // レア率倍率

  comboBoost: 1.0            // コンボ時間倍率
};
```

## ショップのバランス設計

### AP獲得と消費のバランス
```javascript
const apBalance = {
  // AP獲得源
  achievements: {
    basic: 10,      // 基本実績
    advanced: 50,   // 上級実績
    expert: 100     // エキスパート実績
  },
  
  // AP消費先
  items: {
    cheap: 60,      // 安価アイテム
    standard: 90,   // 標準アイテム
    expensive: 150  // 高価アイテム
  }
};
```

### 購入推奨順序
1. **初心者向け**: HP増加 → スコア倍率アップ
2. **中級者向け**: レア率アップ
3. **上級者向け**: コンボ強化 → 復活
4. **リセット**: 戦略変更時のリセット

### アイテム効果の影響度
```javascript
const itemImpact = {
  scoreMultiplier: "高", // スコアに直接影響
  hpBoost: "中",        // 生存率向上

  rareRate: "低",       // 間接的な効果
  comboBoost: "中",     // 上級者向け
  revival: "高"         // 緊急時の保険
};
```

## 将来の拡張予定

### 追加予定アイテム
- **泡速度低下**: 泡の成長速度を遅くする
- **自動回復**: 時間経過でHPが回復
- **経験値ブースト**: 獲得経験値が増加
- **特殊泡確定**: 特定の特殊泡が確定出現



### プレミアム機能
- **アイテムセット**: 複数アイテムをセット価格で購入
- **サブスクリプション**: 月額でAP獲得量増加
- **VIPショップ**: 特別なアイテムが購入可能

## 技術実装詳細

### パフォーマンス最適化
- **遅延読み込み**: アイテム情報の必要時読み込み
- **キャッシュ**: 計算結果のキャッシュ
- **バッチ更新**: UI更新の最適化

### セキュリティ対策
- **データ検証**: 購入データの整合性チェック
- **不正防止**: 異常な購入パターンの検出
- **バックアップ**: データ破損時の復旧機能